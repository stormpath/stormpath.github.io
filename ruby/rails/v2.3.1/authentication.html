

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Authentication &mdash; Stormpath Rails Documentation 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="about.html"/>
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Stormpath Rails Documentation 0.1 documentation" href="index.html"/>
        <link rel="next" title="Registration" href="registration.html"/>
        <link rel="prev" title="User Data" href="user_data.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

  
  <script src="https://cdn.optimizely.com/js/225847041.js"></script>

  
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '986262161469311');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=986262161469311&ev=PageView&noscript=1"
  /></noscript>
</head>

<body class="wy-body-for-nav" role="document">

  
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NQZZFW"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NQZZFW');</script>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Stormpath Rails Documentation
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="about.html#what-is-stormpath">What is Stormpath?</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html#what-is-the-stormpath-rails-gem">What is the Stormpath Rails Gem?</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html#who-should-use-stormpath">Who should use Stormpath?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-a-stormpath-account">Create a Stormpath Account</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-an-api-key-pair">Create an API Key Pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#find-your-stormpath-application">Find Your Stormpath Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#install-the-gem">Install the Gem</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#routes-configuration">Routes configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#start-your-server">Start your server</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#example-applications">Example Applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#default-features">Default Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#disabling-features">Disabling Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#stormpath-client-options">Stormpath Client Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#stormpath-application">Stormpath Application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user_data.html">User Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="user_data.html#current-account">current_account</a><ul>
<li class="toctree-l3"><a class="reference internal" href="user_data.html#resolving-the-current-user-account">Resolving The Current User(Account)</a></li>
<li class="toctree-l3"><a class="reference internal" href="user_data.html#forcing-authentication">Forcing Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="user_data.html#modifying-the-account">Modifying The Account</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="user_data.html#custom-data">Custom Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_data.html#automatic-expansion">Automatic Expansion</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_data.html#current-user-json-api">Current User JSON API</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Authentication</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cookie-authentication">Cookie Authentication</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-token-expiration-time">Setting Token Expiration Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-cookie-flags">Configuring Cookie Flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#token-validation-strategy">Token Validation Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#http-basic-authentication">HTTP Basic Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#oauth2-client-credentials">OAuth2 Client Credentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="#oauth2-password-grant">OAuth2 Password Grant</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="registration.html">Registration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="registration.html#configuration-options">Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#modifying-default-fields">Modifying Default Fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="registration.html#configure-first-name-and-last-name-as-optional">Configure First Name and Last Name as Optional</a></li>
<li class="toctree-l3"><a class="reference internal" href="registration.html#disabling-first-name-and-last-name">Disabling First Name and Last Name</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#creating-custom-fields">Creating Custom Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#changing-field-order">Changing Field Order</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#password-strength-rules">Password Strength Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#email-verification">Email Verification</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#auto-login">Auto Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#overriding-registration">Overriding Registration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="registration.html#controllers">Controllers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#routes">Routes</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#views">Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#json-registration-api">JSON Registration API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="login.html">Login</a><ul>
<li class="toctree-l2"><a class="reference internal" href="login.html#next-uri">Next URI</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#form-customization">Form Customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#controller-private-helper-methods">Controller private &amp; helper methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#json-login-api">JSON Login API</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#overriding-login">Overriding Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="login.html#controllers">Controllers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="login.html#routes">Routes</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#views">Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#using-id-site">Using ID Site</a><ul>
<li class="toctree-l3"><a class="reference internal" href="login.html#id-site-configuration">ID Site Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="social_login.html">Social Login</a><ul>
<li class="toctree-l2"><a class="reference internal" href="social_login.html#facebook-login">Facebook Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-facebook-app">Create a Facebook App</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#specify-allowed-urls">Specify Allowed URLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-facebook-directory">Create a Facebook Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#test-it-out">Test it Out</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="social_login.html#google-login">Google Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-google-project">Create a Google Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#enable-google-login">Enable Google Login</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-oauth-credentials">Create OAuth Credentials</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-google-directory">Create a Google Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#id2">Test it Out</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="social_login.html#linkedin-login">LinkedIn Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-linkedin-application">Create a LinkedIn Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#enable-linkedin-permissions">Enable LinkedIn Permissions</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-linkedin-directory">Create a LinkedIn Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#id3">Test it Out</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="social_login.html#github-login">Github Login</a><ul>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-github-app">Create a Github App</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#create-a-github-directory">Create a Github Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="social_login.html#id4">Test it Out</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="logout.html">Logout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="logout.html#configuration-options">Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="logout.html#overriding-logout">Overriding Logout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="logout.html#controllers">Controllers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="logout.html#routes">Routes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="password_reset.html">Password Reset</a><ul>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#enable-the-workflow">Enable the Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#adjust-workflow-in-config-file">Adjust Workflow in Config File</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#using-the-workflow">Using the Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#auto-login">Auto Login</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="devise_import.html">Import Data from Devise</a><ul>
<li class="toctree-l2"><a class="reference internal" href="devise_import.html#default-configuration">Default Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="devise_import.html#new-application-and-directory">New Application and Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="devise_import.html#custom-account-data">Custom Account Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="devise_import.html#migration-process">Migration Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#default-views">Default Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#custom-views">Custom Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#view-variables">View Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#response-variables">Response Variables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Getting Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Contributors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributors.html#developers">Developers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributors.html#nenad-nikolic">Nenad Nikolić</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributors.html#damir-svrtan">Damir Svrtan</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributors.html#marko-cilimkovic">Marko Ćilimković</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a><ul>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-3-1">Version 2.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-3-0">Version 2.3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-2-0">Version 2.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-1-0">Version 2.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-0-2">Version 2.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#version-2-0-1">Version 2.0.1</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Stormpath Rails Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 







<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Authentication</li>
    <li class="wy-breadcrumbs-aside">
      
          
          <a href="_sources/authentication.txt" rel="nofollow"> View page source</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="authentication">
<span id="id1"></span><h1>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h1>
<p>This library offers several options for securing your application and
authenticating your users.  Which strategy should you use?  The answer depends
on your use case, and we&#8217;ll discuss each one in detail.  But at a high level,
your choices look like this:</p>
<blockquote>
<div><ul class="simple">
<li>If you are building a traditional web app or single page application, you
should use <strong>Cookie Authentication</strong>.</li>
<li>If you are building a mobile application, you should use the <strong>OAuth2
Password Grant</strong>.</li>
<li>If you are building an API service, you can use
<strong>HTTP Basic Authentication</strong> or <strong>OAuth2 Client Credentials</strong>.</li>
</ul>
</div></blockquote>
<div class="section" id="cookie-authentication">
<h2>Cookie Authentication<a class="headerlink" href="#cookie-authentication" title="Permalink to this headline">¶</a></h2>
<p>If you are building a web application that serves traditional HTML pages, or a
Single Page Application (Angular/React), this library will handle the cookies
for you.  No special configuration is necessary.</p>
<p>To use cookie authentication, simply use the <code class="docutils literal"><span class="pre">require_authentication!</span></code> before action:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ProfilesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:require_authentication!</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Behind the scenes we are issuing a OAuth2 Access Token and Refresh Token for
the user, and storing them in secure, HTTPS-Only cookies.  After the user has
logged in, these cookies will be supplied on every request.  Our library will
assert that the Access Token is valid.  If the Access Token is expired, we will
attempt to refresh it with the Refresh Token.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Stormpath-Rails&#8217;s OAuth2 cookie feature will not interfere with any
existing cookie-based session middleware you might have.  The cookies that
Stormpath creates are used exclusively for Stormpath&#8217;s purposes, so it&#8217;s
safe to create your own separate sessions if needed.</p>
</div>
<div class="section" id="setting-token-expiration-time">
<span id="id2"></span><h3>Setting Token Expiration Time<a class="headerlink" href="#setting-token-expiration-time" title="Permalink to this headline">¶</a></h3>
<p>If you need to change the expiration time of the Access Token or Refresh Token,
please login to the Stormpath Admin Console and navigate to the OAuth policy of
your Stormpath Application.  There you will find the settings for each token.</p>
</div>
<div class="section" id="configuring-cookie-flags">
<span id="id3"></span><h3>Configuring Cookie Flags<a class="headerlink" href="#configuring-cookie-flags" title="Permalink to this headline">¶</a></h3>
<p>This library creates two cookies, one for the Access Token and one for the
Refresh Token.  There are several options available for controlling the flags
that are set on these cookies.</p>
<p>Here is an example configuration block, with the default settings:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">accessTokenCookie</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;access_token&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">httpOnly</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">secure</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="l l-Scalar l-Scalar-Plain">domain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>

  <span class="l l-Scalar l-Scalar-Plain">refreshTokenCookie</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;refresh_token&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">httpOnly</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">secure</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="l l-Scalar l-Scalar-Plain">domain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
</pre></div>
</div>
<p>This table describes each setting in detail:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="12%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Cookie Flag</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>domain</td>
<td>null</td>
<td>Set if needed, e.g. &#8220;subdomain.mydomain.com&#8221;.</td>
</tr>
<tr class="row-odd"><td>httpOnly</td>
<td>true</td>
<td>True by default, do not disable without good reason
(exposes tokens to XSS | attacks).</td>
</tr>
<tr class="row-even"><td>path</td>
<td>&#8220;/&#8221;</td>
<td>Set if needed, e.g. &#8220;/newapp&#8221;.</td>
</tr>
<tr class="row-odd"><td>secure</td>
<td>null</td>
<td>Will be <code class="docutils literal"><span class="pre">true</span></code> in HTTPS environments (as detected
by <code class="docutils literal"><span class="pre">req.protocol</span></code>), unless explicitly set to
<code class="docutils literal"><span class="pre">false</span></code> (not recommended!).</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="token-validation-strategy">
<span id="id4"></span><h3>Token Validation Strategy<a class="headerlink" href="#token-validation-strategy" title="Permalink to this headline">¶</a></h3>
<p>When a request comes to your server, this gem will use the Access Token
and Refresh Token cookies to make an authentication decision.  The default
validation strategy (<code class="docutils literal"><span class="pre">local</span></code>) works like this:</p>
<ul class="simple">
<li>If the Access Token signature is valid, and the token is not expired, accept
the request.</li>
<li>If the Access Token is expired, attempt to get a new one from the Stormpath
REST API by using the Refresh Token.</li>
<li>If a new Access Token cannot be obtained, deny the request.</li>
</ul>
<p>With the <code class="docutils literal"><span class="pre">local</span></code> option, our gem only checks the signature and expiration of
the Access Token.  It does not check with the Stormpath REST API to assert that
the Access Token hasn&#8217;t been revoked.</p>
<p>If you would like to check for Access Token revocation on every request, you
should opt-in to the <code class="docutils literal"><span class="pre">stormpath</span></code> validation strategy.  This will make a
network call to the Stormpath REST API.  If the Access Token has been revoked,
or the account has been disabled or deleted, the request will be rejected.</p>
<p>Opt-in to <code class="docutils literal"><span class="pre">stormpath</span></code> validation with this configuration:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">oauth2</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">validationStrategy</span><span class="p p-Indicator">:</span> <span class="s">&#39;stormpath&#39;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When using local validation, your server will not be aware of token revocation
or any changes to the associated Stormpath account.  <strong>This is a security
trade-off that optimizes for performance.</strong>  If you prefer extra security, use
the <code class="docutils literal"><span class="pre">stormpath</span></code> validation option.</p>
<p>If you prefer local validation, for the performance reasons, you can add more
security by doing one of the following:</p>
<ul class="last simple">
<li>Use a short expiration time for your Access Tokens (such as five minutes or
less).  This will limit the amount of time that the Access Token can be used
for validation, while still reducing the number of times that we need to
make a REST API call, with the refresh token, to get a new access token.</li>
<li>Maintain a blacklist of revoked Access Tokens, in your local application
cache. Implement a middleware function that asserts that the Access Token is
not in this cache, and reject the request if true.  We may implement this as
a convenience feature in the future.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="http-basic-authentication">
<h2>HTTP Basic Authentication<a class="headerlink" href="#http-basic-authentication" title="Permalink to this headline">¶</a></h2>
<p>This strategy makes sense if you are building a simple API service that does
not have complex needs around authorization and resource control.  This strategy
is simple because the developer simply supplies their API keys on every request
to your server.</p>
<p>Once the developer has their API keys, they will use them to authenticate with your
API.  For each request they will set the <code class="docutils literal"><span class="pre">Authorization</span></code> header, like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">Authorization</span><span class="o">:</span> <span class="nx">Basic</span> <span class="o">&lt;</span><span class="nx">Base64UrlSafe</span><span class="p">(</span><span class="nx">apiKeyId</span><span class="o">:</span><span class="nx">apiKeySecret</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>How this is done will depend on what tool or library they are using.  For example,
if using curl:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -v --user apiKeyId:apiKeySecret http://localhost:3000/secret
</pre></div>
</div>
<p>You only need to set the <em>require_authentication!</em> callback, but behind the curtains another class is going to be invoked,
which will handle the basic authentication.</p>
</div>
<div class="section" id="oauth2-client-credentials">
<h2>OAuth2 Client Credentials<a class="headerlink" href="#oauth2-client-credentials" title="Permalink to this headline">¶</a></h2>
<p>If you are building an API service and you have complex needs around
authorization and security, this strategy should be used.  In this situation
the developer does a one-time exchange of their API Keys for an Access Token.
This Access Token is time limited and must be periodically refreshed.  This adds a
layer of security, at the cost of being more complex than HTTP Basic
Authentication.</p>
<p>If you&#8217;re not sure which strategy to use, it&#8217;s best to start with HTTP Basic
Authentication. You can always switch to OAuth2 at a later time.</p>
<p>Once a developer has an API Key pair (see above, <em>Issuing API Keys</em>), they will
need to use the OAuth2 Token Endpoint to obtain an Access Token.  In simple
HTTP terms, that request looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">POST</span> <span class="o">/</span><span class="nx">oauth</span><span class="o">/</span><span class="nx">token</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span> <span class="nx">myapi</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="o">:</span> <span class="nx">application</span><span class="o">/</span><span class="nx">x</span><span class="o">-</span><span class="nx">www</span><span class="o">-</span><span class="nx">form</span><span class="o">-</span><span class="nx">urlencoded</span>
<span class="nx">Authorization</span><span class="o">:</span> <span class="nx">Basic</span> <span class="o">&lt;</span><span class="nx">Base64UrlSafe</span><span class="p">(</span><span class="nx">apiKeyId</span><span class="o">:</span><span class="nx">apiKeySecret</span><span class="p">)</span><span class="o">&gt;</span>

<span class="nx">grant_type</span><span class="o">=</span><span class="nx">client_credentials</span>
</pre></div>
</div>
<p>How you construct this request will depend on your library or tool, but the key
parts you need to know are:</p>
<blockquote>
<div><ul class="simple">
<li>The request must be a POST request.</li>
<li>The content type must be form encoded, and the body must contain
<code class="docutils literal"><span class="pre">grant_type=client_credentials</span></code>.</li>
<li>The Authorization header must be Basic and contain the Base64 Url-Encoded
values of the Api Key Pair.</li>
</ul>
</div></blockquote>
<p>If you were doing this request with curl, it would look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">POST</span> <span class="o">--</span><span class="nx">user</span> <span class="nx">api_key_id</span><span class="o">:</span><span class="nx">api_key_secret</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/oauth/token -d grant_type=client_credentials</span>
</pre></div>
</div>
<p>If the credentials are valid, you will get an Access Token response that looks
like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;access_token&quot;</span><span class="o">:</span> <span class="s2">&quot;eyJ0eXAiOiJKV1QiL...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;token_type&quot;</span><span class="o">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
  <span class="s2">&quot;expires_in&quot;</span><span class="o">:</span> <span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The response is a JSON object which contains:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">access_token</span></code> - Your OAuth Access Token.  This can be used to authenticate
on future requests.</li>
<li><code class="docutils literal"><span class="pre">token_type</span></code> - This will always be <code class="docutils literal"><span class="pre">&quot;bearer&quot;</span></code>.</li>
<li><code class="docutils literal"><span class="pre">expires_in</span></code> - This is the amount of seconds (<em>as an integer</em>) for which
this token is valid.</li>
</ul>
<p>With this token you can now make requests to your API.  This request is simpler,
as only thing you need to supply is <code class="docutils literal"><span class="pre">Authorization</span></code> header with the Access
Token as a bearer token.  If you are using curl, that request looks like this:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -v -H <span class="s2">&quot;Authorization: Bearer eyJ0eXAiOiJKV1QiL...&quot;</span> http://localhost:3000/secret
</pre></div>
</div>
<p>In order to protect your API endpoint and allow this form of authentication,
you just need to use the <em>require_authentication!</em> callback again.</p>
<p>By default the Access Tokens are valid for one hour.  If you want to change
the expiration of these tokens you will need to configure it in the server
configuration, like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">oauth2</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">client_credentials</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">accessToken</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">ttl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3600 // your custom TTL, in seconds, goes here</span>
</pre></div>
</div>
</div>
<div class="section" id="oauth2-password-grant">
<h2>OAuth2 Password Grant<a class="headerlink" href="#oauth2-password-grant" title="Permalink to this headline">¶</a></h2>
<p>This is the authentication strategy that you will want to use for mobile clients.
In this situation the end-user supplies their username and password to your
mobile application.  The mobile application sends that username and password to
your Rails application, which then verifies the password with Stormpath.</p>
<p>If the account is valid and the password is correct, Stormpath will generate
an Access Token for the user.  Your server gets this Access Token from Stormpath
and then sends it back to your mobile application.</p>
<p>The mobile application then stores the Access Token in a secure location, and
uses it for future requests to your API.  Every time the mobile application uses
this Access Token your server will verify that it&#8217;s still valid, using Stormpath.</p>
<p>When a user wants to login to your mobile application, the mobile application
should make this request to your Rails application:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>POST /oauth/token HTTP/1.1
Host: myapi.com
Content-Type: application/x-www-form-urlencoded

<span class="nv">grant_type</span><span class="o">=</span>password
<span class="p">&amp;</span><span class="nv">username</span><span class="o">=</span>user@gmail.com
<span class="p">&amp;</span><span class="nv">password</span><span class="o">=</span>theirPassword
</pre></div>
</div>
<p>If the authentication is successful, the Stormpath API will return an Access
Token to your mobile application.  The response will look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;refresh_token&quot;</span><span class="o">:</span> <span class="s2">&quot;eyJraWQiOiI2...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;stormpath_access_token_href&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accessTokens/3bBAHmSuTJ64DM574awVen&quot;</span><span class="p">,</span>
  <span class="s2">&quot;token_type&quot;</span><span class="o">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
  <span class="s2">&quot;access_token&quot;</span><span class="o">:</span> <span class="s2">&quot;eyJraWQiOiI2Nl...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;expires_in&quot;</span><span class="o">:</span> <span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Your mobile application should store the Access Token and Refresh Token.  By
default the Access Token is valid for 1 hour and the Refresh Token for 60 days.
When the Access Token expires you can get a new Access Token by using the
Refresh Token, making this request to your Rails application:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">POST</span> <span class="o">/</span><span class="nx">oauth</span><span class="o">/</span><span class="nx">token</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span> <span class="nx">myapi</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="o">:</span> <span class="nx">application</span><span class="o">/</span><span class="nx">x</span><span class="o">-</span><span class="nx">www</span><span class="o">-</span><span class="nx">form</span><span class="o">-</span><span class="nx">urlencoded</span>

<span class="nx">grant_type</span><span class="o">=</span><span class="nx">refresh_token</span>
<span class="o">&amp;</span><span class="nx">refresh_token</span><span class="o">=</span><span class="nx">eyJraWQiOiI2</span><span class="p">...</span>
</pre></div>
</div>
<p>The response will contain a new Access Token.  Once the Refresh Token expires,
the user will have to re-authenticate with a username and password.</p>
<p>You can control the lifetime of the Access Token and Refresh Token by modifying
the OAuth Policy of your Stormpath Application.  This can be found by logging
into the Stormpath Admin Console and finding your Application.</p>
<p>For full documentation on our OAuth2 Access Token features, please see
<a class="reference external" href="http://docs.stormpath.com/guides/token-management/">Using Stormpath for OAuth 2.0 and Access/Refresh Token Management</a></p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="registration.html" class="btn btn-neutral float-right" title="Registration" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_data.html" class="btn btn-neutral" title="User Data" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Stormpath, Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
   
  <script src="//cdn.optimizely.com/js/225847041.js"></script>


  

</body>
</html>