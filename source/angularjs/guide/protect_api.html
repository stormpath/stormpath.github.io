

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Configure the Server &mdash; Stormpath AngularJS Guide 0.0.2 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Stormpath AngularJS Guide 0.0.2 documentation" href="index.html"/>
        <link rel="next" title="Configure the Angular App" href="configure_angular.html"/>
        <link rel="prev" title="Create a Stormpath Tenant" href="create_tenant.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Stormpath AngularJS Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#what-we-re-building">What We&#8217;re Building</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#example-project">Example Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#how-to-get-support">How to get Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="create_new_project.html">Creating a Fullstack Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="create_new_project.html#installing-node-grunt-bower-and-yeoman">Installing Node, Grunt, Bower and Yeoman</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_new_project.html#create-an-angular-fullstack-project">Create an Angular-Fullstack Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_new_project.html#install-the-stormpath-packages">Install the Stormpath Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_new_project.html#upgrade-express">Upgrade Express</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="create_tenant.html">Create a Stormpath Tenant</a><ul>
<li class="toctree-l2"><a class="reference internal" href="create_tenant.html#sign-up-for-stormpath">Sign up for Stormpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_tenant.html#create-an-api-key-pair">Create an API Key Pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_tenant.html#create-a-stormpath-application">Create a Stormpath Application</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Configure the Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-environment-variables">Setting Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-the-stormpath-middleware">Add the Stormpath Middleware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reload-the-app">Reload the App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configure_angular.html">Configure the Angular App</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configure_angular.html#add-stormpath-to-the-angular-application">Add Stormpath to the Angular Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="configure_angular.html#configure-the-ui-router-integration">Configure the UI Router Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="customize_menu.html">Customize the Menu</a><ul>
<li class="toctree-l2"><a class="reference internal" href="customize_menu.html#modify-navbar-html">Modify navbar.html</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="login.html">Create the Login Form</a><ul>
<li class="toctree-l2"><a class="reference internal" href="login.html#generate-the-login-route">Generate the /login Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="login.html#use-the-login-form-directive">Use the Login Form Directive</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="register.html">Create the Registration Form</a><ul>
<li class="toctree-l2"><a class="reference internal" href="register.html#generate-the-register-route">Generate the /register Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#add-the-registration-form-directive">Add the Registration Form Directive</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#generate-the-register-verify-route">Generate the /register/verify Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#add-the-sptoken-parameter">Add the sptoken Parameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#use-the-email-verification-directive">Use the Email Verification Directive</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#configure-the-directory">Configure the Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#try-it-register-for-an-account">Try It, Register for an Account!</a></li>
<li class="toctree-l2"><a class="reference internal" href="register.html#customizing-the-form">Customizing the Form</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user_profile.html">Create the Profile View</a><ul>
<li class="toctree-l2"><a class="reference internal" href="user_profile.html#generate-the-profile-route">Generate the /profile Route</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_profile.html#force-authentication">Force Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_profile.html#create-the-view">Create the View</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_profile.html#try-it-out-see-your-profile">Try It Out, See Your Profile!</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="password_reset.html">Password Reset Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#generate-the-routes">Generate the Routes</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#add-the-sptoken-parameter">Add the sptoken Parameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#use-the-password-reset-directives">Use the Password Reset Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#configure-the-directory">Configure the Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="password_reset.html#try-it-reset-your-password">Try It, Reset your Password!</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="access_control.html">Access Control</a><ul>
<li class="toctree-l2"><a class="reference internal" href="access_control.html#ui-state-control">UI State Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="access_control.html#helper-directives">Helper Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="access_control.html#api-security">API Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wait_for_user.html">Waiting For User State</a><ul>
<li class="toctree-l2"><a class="reference internal" href="wait_for_user.html#use-the-waitforuser-option">Use the waitForUser Option</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="coming_soon.html">Coming Soon!</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Stormpath AngularJS Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Configure the Server</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/protect_api.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="configure-the-server">
<span id="protect-api"></span><h1>Configure the Server<a class="headerlink" href="#configure-the-server" title="Permalink to this headline">¶</a></h1>
<p>In the previous section, <a class="reference internal" href="create_new_project.html#create-new-project"><em>Creating a Fullstack Project</em></a>, we created a simple
Express.js and installed the <a class="reference external" href="https://github.com/stormpath/stormpath-sdk-express">Stormpath Express SDK</a>.  We are going to use that
SDK to secure the API endpoints in the Express server.</p>
<div class="section" id="setting-environment-variables">
<h2>Setting Environment Variables<a class="headerlink" href="#setting-environment-variables" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/stormpath/stormpath-sdk-express">Stormpath Express SDK</a> needs the API Key and Application information that
we collected in the section <a class="reference internal" href="create_tenant.html#create-tenant"><em>Create a Stormpath Tenant</em></a>.  We will provide this
information to the SDK by exporting it to the environment.</p>
<p>The <tt class="docutils literal"><span class="pre">Gruntfile</span></tt> of this project has a task that will automatically export the
properties that are added to <tt class="docutils literal"><span class="pre">server/config/local.env.js</span></tt>.  Open that file,
add these properties to the export block, and fill in your values:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">DOMAIN</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9000&#39;</span><span class="p">,</span>
  <span class="nx">SESSION_SECRET</span><span class="o">:</span> <span class="s2">&quot;dashboard-secret&quot;</span><span class="p">,</span>
  <span class="c1">// Control debug level for modules using visionmedia/debug</span>
  <span class="nx">DEBUG</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="nx">STORMPATH_API_KEY_ID</span><span class="o">:</span> <span class="s1">&#39;YOUR_KEY_ID&#39;</span><span class="p">,</span>
  <span class="nx">STORMPATH_API_KEY_SECRET</span><span class="o">:</span> <span class="s1">&#39;YOUR_KEY_SECRET&#39;</span><span class="p">,</span>
  <span class="nx">STORMPATH_APP_HREF</span><span class="o">:</span> <span class="s1">&#39;YOUR_APP_HREF&#39;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Grunt will automatically export these values to the environment, and the
<a class="reference external" href="https://github.com/stormpath/stormpath-sdk-express">Stormpath Express SDK</a> will pick them up automatically.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This file will be hidden from Git and never checked into your repo, this
is for security purposes.  When you deploy your application to production
you should use the features of your deployment system to export these
variables to your environment.  For example if you are using Herkou, you
would use the <a class="reference external" href="https://devcenter.heroku.com/articles/config-vars">Configuration and Config Vars</a> feature.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can manually export the values to the environment by using the <tt class="docutils literal"><span class="pre">export</span></tt>
or <tt class="docutils literal"><span class="pre">set</span></tt> commands in your terminal.</p>
<p><strong>Unix/Linux/Mac</strong>:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kr">export</span> <span class="nx">STORMPATH_API_KEY_ID</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_API_KEY_ID</span>
<span class="kr">export</span> <span class="nx">STORMPATH_API_KEY_SECRET</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_API_KEY_SECRET</span>
<span class="kr">export</span> <span class="nx">STORMPATH_APP_HREF</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_APP_HREF</span>
</pre></div>
</div>
<p><strong>Windows</strong>:</p>
<div class="last highlight-js"><div class="highlight"><pre><span class="nx">set</span> <span class="nx">STORMPATH_API_KEY_ID</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_API_KEY_ID</span>
<span class="nx">set</span> <span class="nx">STORMPATH_API_KEY_SECRET</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_API_KEY_SECRET</span>
<span class="nx">set</span> <span class="nx">STORMPATH_APP_HREF</span><span class="o">=</span><span class="nx">YOUR_STORMPATH_APP_HREF</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="add-the-stormpath-middleware">
<h2>Add the Stormpath Middleware<a class="headerlink" href="#add-the-stormpath-middleware" title="Permalink to this headline">¶</a></h2>
<p>Find the file <tt class="docutils literal"><span class="pre">server/routes.js</span></tt>.</p>
<p>This file is attaching some routes to the Express application that is setup in
<tt class="docutils literal"><span class="pre">server/app.js</span></tt>.</p>
<p>We want to initialize the Stormpath middleware and add it before our API
declaration, so that the API will be automatically protected.</p>
<p>First things first, you need to require the SDK - place this at the top of the
file:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">stormpathExpressSdk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stormpath-sdk-express&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Then you want to create an instance of the Stormpath middleware.  You can pass
options, but in our case, we are just going to make a simple call and use all
the default options.  Add this line before the <tt class="docutils literal"><span class="pre">module.exports</span></tt> statement:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">spMiddleware</span> <span class="o">=</span> <span class="nx">stormpathExpressSdk</span><span class="p">.</span><span class="nx">createMiddleware</span><span class="p">();</span>
</pre></div>
</div>
<p>Then inside the module.exports, before any other <cite>app</cite> statements:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">spMiddleware</span><span class="p">.</span><span class="nx">attachDefaults</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></div>
</div>
<p>This will attach the following route handlers to your Express app:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">POST</span> <span class="pre">/oauth/token</span></tt> (accepts the login form POST, returns an access token)</li>
<li><tt class="docutils literal"><span class="pre">POST</span> <span class="pre">/api/users</span></tt> (for creating new users)</li>
<li><tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/api/users/current</span></tt> (for getting info about the current user, as permitted by the access token)</li>
<li><tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/logout</span></tt> (for ending the current session, the access token is destroyed)</li>
</ul>
<p>The last thing we need to do is secure the things endpoint.  Modify that line
to use the authenticate middleware:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/api/things&#39;</span><span class="p">,</span> <span class="nx">spMiddleware</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./api/thing&#39;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="reload-the-app">
<h2>Reload the App<a class="headerlink" href="#reload-the-app" title="Permalink to this headline">¶</a></h2>
<p>Restart the server by running <tt class="docutils literal"><span class="pre">grunt</span> <span class="pre">serve</span></tt> again.  You should now see that
the features are no longer listed - this is because the endpoint fails to load
with a <tt class="docutils literal"><span class="pre">401</span> <span class="pre">Unauthorized</span></tt> - you can see this by looking inside the web console
in your browser:</p>
<img alt="_images/features-unauthorized.png" src="_images/features-unauthorized.png" />
<p>Our API is now protected from unauthorized, anonymous access.  In the next two
sections, we will show you how to create a registration form and a login form.
At that point, you will be able to login and have access to the API.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="configure_angular.html" class="btn btn-neutral float-right" title="Configure the Angular App">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="create_tenant.html" class="btn btn-neutral" title="Create a Stormpath Tenant"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Stormpath.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>