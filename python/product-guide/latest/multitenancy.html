

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6. Multi-Tenancy with Stormpath &mdash; Stormpath Python Documentation  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="about.html"/>
    <link rel="top" title="Stormpath Python Documentation  documentation" href="index.html"/>
        <link rel="next" title="7. Using ID Site" href="idsite.html"/>
        <link rel="prev" title="5. Authorization With Stormpath" href="auth_z.html"/>
<!-- Facebook Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '986262161469311');
  fbq('track', "PageView");
</script>
<noscript>
  <img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=986262161469311&ev=PageView&noscript=1"
  />
</noscript>
<!-- End Facebook Pixel Code -->

<!-- Algolia Search Header Code -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />

<!-- End Algolia Search Header Code -->



  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  

          
            <a href="index.html" class="icon icon-home"> Stormpath Python Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

  <div class="langpicker-container">
    <a href="#langpicker" class="langpicker-link">
      <i class="fa fa-code"></i>
      Switch Language
    </a>
    <div id="langpicker" style="display:none;">
      <div class="">
        <a href="/csharp/product-guide/latest/multitenancy.html">C#</a>
      </div>
      <div class="">
        <a href="/php/product-guide/latest/multitenancy.html">PHP</a>
      </div>
      <div class="current">
        <a href="/python/product-guide/latest/multitenancy.html">Python</a>
      </div>
      <div class="">
        <a href="/rest/product-guide/latest/multitenancy.html">REST</a>
      </div>
      <div class="">
        <a href="/vbnet/product-guide/latest/multitenancy.html">Visual Basic</a>
      </div>
      <!--
      <div class="">
        <a href="/java/product-guide/latest/multitenancy.html">Java</a>
      </div>
      <div class="">
        <a href="/nodejs/product-guide/latest/multitenancy.html">Node.js</a>
      </div>
      -->
    </div>
  </div>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">1. About Stormpath</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">2. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="accnt_mgmt.html">3. Account Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth_n.html">4. Authenticating Accounts with Stormpath</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth_z.html">5. Authorization With Stormpath</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Multi-Tenancy with Stormpath</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-a-multi-tenant-application">6.1. What Is a Multi-Tenant Application?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modeling-tenants-in-stormpath">6.2. Modeling Tenants in Stormpath</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multi-tenancy-and-the-stormpath-data-model">6.2.1 Multi-Tenancy and the Stormpath Data Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#why-use-organizations">Why use Organizations?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#account-store-strategies-for-multi-tenancy">6.2.1. Account Store Strategies for Multi-Tenancy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#strategy-1-directory-per-organization">Strategy 1: Directory per Organization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategy-2-group-per-organization">Strategy 2: Group per Organization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#working-with-organizations">6.2.2. Working with Organizations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-to-create-an-organization">How to Create an Organization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-an-account-store-to-an-organization">Adding an Account Store to an Organization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-an-organization-as-an-account-store-for-an-application">Registering an Organization as an Account Store for an Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-an-account-to-an-organization">Adding an Account to an Organization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#authenticating-an-account-against-an-organization">6.3. Authenticating an Account against an Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#routing-users-to-their-tenant">6.4 Routing Users to their Tenant</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sub-domain">6.4.1. Sub-Domain</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#separate-domain-space">Separate Domain Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#combine-with-login-form-field">Combine With Login Form Field</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#login-form-field">6.4.2. Login Form Field</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="idsite.html">7. Using ID Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="errors.html">Stormpath Error Codes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Stormpath Python Documentation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>6. Multi-Tenancy with Stormpath</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="multi-tenancy-with-stormpath">
<span id="multitenancy"></span><h1>6. Multi-Tenancy with Stormpath<a class="headerlink" href="#multi-tenancy-with-stormpath" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-a-multi-tenant-application">
<h2>6.1. What Is a Multi-Tenant Application?<a class="headerlink" href="#what-is-a-multi-tenant-application" title="Permalink to this headline">¶</a></h2>
<p>Is your application a multi-tenant application? If you already know, then feel free to <a class="reference internal" href="#multitenancy-modeling"><span class="std std-ref">skip this section</span></a>. If you are unsure, there are two questions that might clarify the issue for you. The first pertains to your application architecture, and the second to your application&#8217;s relationship to its users.</p>
<p><strong>Will your application&#8217;s customers share the same infrastructure?</strong></p>
<p>The best way to understand this first aspect of multi-tenancy is by thinking of a condo: lots of residents making use of a shared building infrastructure while maintaining their own private and secure living areas. Similar to this, a <strong>multi-tenant application</strong> is a single application infrastructure that services multiple organization tenants simultaneously.</p>
<p>For example, if you are creating your own cloud-based team chat application, you will have multiple organizations connecting to the same servers and databases, and using the same basic application code. The infrastructure, both hardware and software, will be shared among all of your customers.</p>
<p>However, there are plenty of cloud-based services that are not multi-tenant! So now we need to ask another question.</p>
<p><strong>If your application offered subscriptions, would those be paid by individuals or organizations?</strong></p>
<p>Perhaps your application will be totally free to use, but don&#8217;t worry, payment here is simply a way of understand the relationship your users have to your application.</p>
<p>Consider the difference between two internet chat applications: WhatsApp and Slack. When WhatsApp briefly offered a paid subscription, it was paid on a per-account basis. With Slack, an individual user can&#8217;t pay for a subscription, that has to happen on the Team level. So what&#8217;s the difference here?</p>
<p>WhatsApp is not a multi-tenant application, because every user&#8217;s relationship to the application only exists in that simple connection: A user has a WhatsApp account. WhatsApp is a &#8220;multi-user&#8221; application, but it is not a &#8220;multi-tenant&#8221; application.</p>
<p>Tenants are organizations of people who use your application in some shared way. So Slack calls their tenants &#8220;Teams&#8221;, and when you log in to Slack you are also logging in to a Team. This also means that a user cannot create an account with Slack, they must create an account with a Slack Team. So, with WhatsApp, a user has a WhatsApp account. With Slack, a user belongs to a Slack Team, and then has an Account within that Team.</p>
<p>If your application is offering (1) shared software and hardware infrastructure to (2) client organizations, then you have a multi-tenant application! Now, for privacy and security purposes, it&#8217;s very important that your application maintain data segmentation between its multiple tenants. At Stormpath, this segmentation is baked-in to everything that we offer.</p>
</div>
<div class="section" id="modeling-tenants-in-stormpath">
<span id="multitenancy-modeling"></span><h2>6.2. Modeling Tenants in Stormpath<a class="headerlink" href="#modeling-tenants-in-stormpath" title="Permalink to this headline">¶</a></h2>
<p>Now that we have an understanding of what a multi-tenant application is we can move on to the next important step, which is understanding how your multi-tenant userbase can be modeled using Stormpath&#8217;s Data model.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Stormpath&#8217;s data model is designed to be as flexible (and therefore powerful) as it can be. If at any point you have a question, do not hesitate to <a class="reference external" href="mailto:support&#37;&#52;&#48;stormpath&#46;com">get in touch</a>.</p>
</div>
<div class="section" id="multi-tenancy-and-the-stormpath-data-model">
<h3>6.2.1 Multi-Tenancy and the Stormpath Data Model<a class="headerlink" href="#multi-tenancy-and-the-stormpath-data-model" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s start with a quick overview of the Stormpath resources involved in a multi-tenant data model, starting with the one resource that is purpose-built for multi-tenancy:</p>
<p><strong>Organizations</strong></p>
<p>Organizations are the most important modeling resource for multi-tenancy, as each Stormpath Organization maps to one of your application&#8217;s tenants. They serve as the first point of contact between your Application resource and the rest of your user base, so any login attempts to Stormpath will first be directed to an Organization. The Organization will then in turn use either Directories or Groups to store its user Accounts.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Remember:</strong> Stormpath itself is a multi-tenant application, so your Stormpath Tenant resource represents your space within Stormpath.</p>
<p class="last">Your application&#8217;s tenants are represented by Organization resources. Do not confuse the two! The Stormpath Tenant has almost no relevance to this multi-tenancy discussion, which is about your application&#8217;s tenants.</p>
</div>
<p>For more about user log-in, see <a class="reference internal" href="#multitenancy-auth-to-org"><span class="std std-ref">6.3. Authenticating an Account against an Organization</span></a> below.</p>
<p>For more information about the Organization resource, see:</p>
<ul class="simple">
<li><a class="reference internal" href="#multitenancy-why-orgs"><span class="std std-ref">Why use Organizations?</span></a></li>
<li><a class="reference internal" href="#multitenancy-organizations"><span class="std std-ref">Working With Organizations</span></a></li>
</ul>
<p><strong>Directories</strong></p>
<p>Directories are the the top-level Account Store for both Accounts and Groups. All of your Accounts will have to exist inside a Directory. Here is a very simple example of how an Application, Organization and Directory can relate to one another:</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="_images/simple_ERD_TpD.png"><img alt="Directory with Organization and Application" src="_images/simple_ERD_TpD.png" style="width: 191.07px; height: 326.37px;" /></a>
<p class="caption"><span class="caption-text"><em>Application + Organization + Directory</em></span></p>
</div>
<p>A few more relevant points about the Directory resource:</p>
<ul class="simple">
<li>All Accounts within a Directory must have a unique email address</li>
<li>All Groups within a Directory must have a unique name</li>
<li>Password and Account Creation Policies are defined on a per-Directory basis</li>
<li>Emails are configured on a per-Directory basis</li>
</ul>
<p>Whether you choose to have one Directory for each Organization, or multiple Organizations within one Directory depends on your requirements. More on that distinction can be found <a class="reference internal" href="#multitenancy-strategies"><span class="std std-ref">below</span></a>.</p>
<p><strong>Groups</strong></p>
<p>Groups must always belong to a Directory, but they are otherwise very flexible. Specifically, they have two functions worth mentioning in this context.</p>
<ul class="simple">
<li>First of all, Groups can be the primary Account Store for your Organization: So you could have one Directory for your application, and then one Group for each tenant Organization. More on this <a class="reference internal" href="#multitenancy-strategies"><span class="std std-ref">below</span></a>.</li>
<li>Secondly, Groups can also be used to model user roles, like an &#8220;admin&#8221; user role. Below you can find a simple diagram with a Group being used both to model a tenant and a role:</li>
</ul>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="_images/simple_ERD_TpG.png"><img alt="Group with Directory, Organization, and Application" src="_images/simple_ERD_TpG.png" style="width: 259.05px; height: 435.6px;" /></a>
<p class="caption"><span class="caption-text"><em>Application + Organization + Directory</em></span></p>
</div>
<div class="section" id="why-use-organizations">
<span id="multitenancy-why-orgs"></span><h4>Why use Organizations?<a class="headerlink" href="#why-use-organizations" title="Permalink to this headline">¶</a></h4>
<p>At this point, it might seem like all your tenants need are Account Stores for their users, so Organizations might seem like an additional and unnecessary layer of complexity. So what is the point of using Organizations?</p>
<p>The Organization resource allows your application&#8217;s tenants to have as many, or as few, Directories and Groups as they want, while also maintaining strict data segregation. So if a tenant requires a Cloud Directory, a Google Social Directory, and an LDAP Directory, all of these can sit under the umbrella of a single Organization resource that represents their data space in your app.</p>
<p>Although Organizations do not themselves own Accounts in the same way as Directories and Groups, they can be mapped to Applications as Account Stores for the purposes of user log in. This means that they can be used as, among other things, a single-point of access control to an Application. For example, if you wanted to enable login for a new tenant in your multi-tenant application, all you would have to do is map all of the relevant Directories and/or Groups to your Organization, and then map that Organization to your Application as an Account Store. If at some future point you want to disable that tenant, all you have to do is remove the Account Store Mapping between that Organization and your Application, and the tenant&#8217;s users would no longer be able to log in.</p>
</div>
</div>
<div class="section" id="account-store-strategies-for-multi-tenancy">
<span id="multitenancy-strategies"></span><h3>6.2.1. Account Store Strategies for Multi-Tenancy<a class="headerlink" href="#account-store-strategies-for-multi-tenancy" title="Permalink to this headline">¶</a></h3>
<p>Your primary consideration when modeling users in Stormpath always begins with the Directory that will contain the user Accounts. With multi-tenancy, you always have one Organization resource for every one of your tenants. The additional consideration is whether each of those Organizations has its own Directory, or whether all Organizations share a single Directory.</p>
<p>To help you decide which strategy is best, answer the following questions:</p>
<ul class="simple">
<li><strong>Can a user access multiple tenants with the same credentials?</strong></li>
<li><strong>Will your tenants all have different password strength requirements?</strong></li>
</ul>
<p>If the answer to either of these questions is &#8220;Yes&#8221;, then you will want to map each Organization to its own Directory. We will call this the <a class="reference internal" href="#multitenancy-dpo"><span class="std std-ref">&#8220;Directory per Organization&#8221; strategy</span></a>.</p>
<p>If the answer to either of them is &#8220;No&#8221;, then you will want to have only one Directory, and map each Organization to its own Group. We will call this the <a class="reference internal" href="#multitenancy-gpo"><span class="std std-ref">&#8220;Group per Organization&#8221; strategy</span></a>.</p>
<p>The reasoning here is very simple: because Stormpath stores certain things on the Directory resource, if you want each of your tenants to be able to customize things that are stored on the Directory level, then each one will need their own Directory!</p>
<div class="section" id="strategy-1-directory-per-organization">
<span id="multitenancy-dpo"></span><h4>Strategy 1: Directory per Organization<a class="headerlink" href="#strategy-1-directory-per-organization" title="Permalink to this headline">¶</a></h4>
<p>This first strategy has, as the name implies, one Directory for every tenant Organization. A few questions to think about this for this strategy:</p>
<p><strong>If a user has signed up for an Account with one of your tenants, are they able to use that same email to create an Account in another tenant?</strong></p>
<p>All Accounts within a Directory must have a unique <code class="docutils literal"><span class="pre">email</span></code>, but no such restriction exists between Directories. So if you want to allow people to use the same email to create separate Accounts for each of your tenants, this is the right strategy.</p>
<p><strong>Should each tenant have the ability to define their own password strength policy?</strong></p>
<p>Password Policy is defined off of the Directory, so if each tenant has their own Directory, they also can configure their own Password Policy.</p>
<p><strong>Should each tenant have the ability to send different emails as part of the user Account creation process?</strong></p>
<p>The automated emails that Stormpath sends as part of user registration are also defined on the Directory.</p>
<p><strong>Do you not require application-wide Groups that are available for all tenants?</strong></p>
<p>Groups exist within Directories, so having Groups associated with multiple tenants is only possible when those tenants as represented as Groups, not Directories.</p>
<div class="section" id="directory-per-organization-example">
<h5>Directory per Organization Example<a class="headerlink" href="#directory-per-organization-example" title="Permalink to this headline">¶</a></h5>
<p>Here is an example implementation that uses Directories to model tenants. It is important to note that this is just an example. Stormpath has a very flexible data model with intentionally versatile resources. If you&#8217;d like to discuss your particular implementation needs please <a class="reference external" href="mailto:support&#37;&#52;&#48;stormpath&#46;com">get in touch</a>!</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="_images/ERD_TpD.png"><img alt="Tenant per Directory" src="_images/ERD_TpD.png" style="width: 1248.3px; height: 996.3px;" /></a>
<p class="caption"><span class="caption-text"><em>Directory per Organization ERD.</em></span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Everything discussed occurs inside the private data space that we refer to as your Stormpath Tenant, which is represented by the Tenant resource but does not play any part in multi-tenancy.</p>
</div>
<p>The scenario demonstrates a multi-tenant userbase with two tenants, each of which is represented by their own Organization resource. Each tenant Organization in turn uses a Directory as its Account Store. There are a few points to highlight in this diagram:</p>
<ul class="simple">
<li>The ability to log into the &#8220;Lighting Banking&#8221; application is controlled by the Account Store Mappings that exist between the Application resource and the Organization resources. To enable or disable a tenant (and its userbase) from logging-in, all you would have to do is enable or disable this Account Store Mapping.</li>
<li>If Claire wanted to create another Account with Bank of B using the same email address, she would be allowed to, since email uniqueness is enforced only inside a Directory.</li>
<li>Any role Groups must be created separately, on a per-Directory basis. If you decided to create a new role, a new Group resource representing that role would have to be added to each of your tenant Directories if you wanted the Accounts in that Directory to be able to be assigned that role.</li>
<li>In order to allow Application Administrators to log in to the app, you&#8217;d have to create a new Directory just for them, which is separately mapped to the Application as an Account Store. Since this Directory does not represent a tenant, no Organization resource is created.</li>
</ul>
</div>
</div>
<div class="section" id="strategy-2-group-per-organization">
<span id="multitenancy-gpo"></span><h4>Strategy 2: Group per Organization<a class="headerlink" href="#strategy-2-group-per-organization" title="Permalink to this headline">¶</a></h4>
<p>The other multi-tenancy option is to have a single Directory under which each of your application&#8217;s tenants has their own Group. A few questions to think about this for this strategy:</p>
<p><strong>Do you want to guarantee ``email`` and ``username`` uniqueness across all tenants?</strong></p>
<p>With this strategy, all of your user Accounts are contained within the same Directory, so no two Accounts can have the same email address. This means you can create unified cross-tenant user identities, which allows for things like single-sign-on and account sharing between tenants on your application.</p>
<p><strong>Do all tenants share password and email policies?</strong></p>
<p>These policies are configured on the Directory. Since all of your tenants will be represented by Groups inside one Directory, they will all share one password policy, and one email policy.</p>
<p><strong>Do you want to ensure that tenant names are unique?</strong></p>
<p>Since the Group <code class="docutils literal"><span class="pre">name</span></code> must be unique within a Directory, you can guarantee that your tenants names will not be duplicates.</p>
<p><strong>You want to have application-wide roles that span across tenants.</strong></p>
<div class="section" id="tenants-as-groups-example">
<h5>Tenants as Groups Example<a class="headerlink" href="#tenants-as-groups-example" title="Permalink to this headline">¶</a></h5>
<p>Below we have an example of an implementation that uses Groups to model tenants. This shows just one possible scenario, and if you&#8217;d like to discuss your particular implementation needs please <a class="reference external" href="mailto:support&#37;&#52;&#48;stormpath&#46;com">get in touch</a>!</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="_images/ERD_TpG.png"><img alt="Tenant per Group" src="_images/ERD_TpG.png" style="width: 1422.9px; height: 1064.7px;" /></a>
<p class="caption"><span class="caption-text"><em>Tenants as Groups ERD</em></span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Once again, everything here is happening inside your private Stormpath Tenant, not to be confused with your application&#8217;s tenants!</p>
</div>
<p>Just as with the Tenants-as-Directories strategy, every Tenant is modeled by its own dedicated Organization, but in this case each Organization uses the same Directory as its Account Store. The different tenant&#8217;s user Accounts are instead organized using Groups. This all means that:</p>
<ul class="simple">
<li>You can still control access to the Application by enabling or disabling the Account Store Mappings between the Organizations and the Application resource.</li>
<li>If Claire tried to create another Account with Bank of B using the same email address she&#8217;d used with Bank of A, she would be unable to, since emails must be unique within a Directory.</li>
<li>If there were a role Group that you wanted to be shared among the tenants, it is as simple as creating one instance of it and then associating Accounts with it.</li>
<li>Application Administrators just need their own Role Group, which is then mapped as an Account Store with the Application.</li>
<li>Claire and Esther do not have access to your application&#8217;s Admin Console, because that is only allowed for members of the &#8220;App Admins&#8221; role Group. If, however, Claire were hired as an Application Administrator, then she could be easily added to the &#8220;App Admins&#8221; Group and inherit all of its permissions.</li>
</ul>
</div>
<div class="section" id="naming-your-tenant-groups">
<h5>Naming Your Tenant Groups<a class="headerlink" href="#naming-your-tenant-groups" title="Permalink to this headline">¶</a></h5>
<p>As this is the most common strategy used by our customers, we have found some minor naming conventions that are very powerful and we consider to be best-practice.</p>
<p>First of all, the name of your tenant Organization will have a unique <code class="docutils literal"><span class="pre">nameKey</span></code>, for example <code class="docutils literal"><span class="pre">bank-of-a</span></code>. This <code class="docutils literal"><span class="pre">nameKey</span></code> this can be used for organizing tenant Groups and sub-Groups.</p>
<p>For example, if your Organization&#8217;s <code class="docutils literal"><span class="pre">nameKey</span></code> is <code class="docutils literal"><span class="pre">bank-of-a</span></code>, you could name the Group <code class="docutils literal"><span class="pre">bank-of-a.tenant</span></code>. If you want to create sub-Groups for roles like <code class="docutils literal"><span class="pre">users</span></code> and <code class="docutils literal"><span class="pre">admins</span></code>, we recommend that you prepend the <code class="docutils literal"><span class="pre">nameKey</span></code> to their <code class="docutils literal"><span class="pre">name</span></code> Attribute, along with a descriptive name of what kind of Group it is:</p>
<p><code class="docutils literal"><span class="pre">bank-of-a.role.users</span></code></p>
<p><code class="docutils literal"><span class="pre">bank-of-a.role.admin</span></code></p>
<p>This has two benefits:</p>
<ol class="arabic simple">
<li>It makes it easy to find all the role Groups for that particular tenant, since you can search for the nameKey:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bank-of-a.role.*&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Or, if you wanted to retrieve the tenant Group and all of its sub-Groups, make the query a little less restrictive by removing the &#8220;role&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bank-of-a.*&#39;</span><span class="p">})</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>It ensures that no tenant sub-Groups have name collisions between tenants.</li>
</ol>
</div>
</div>
</div>
<div class="section" id="working-with-organizations">
<span id="multitenancy-organizations"></span><h3>6.2.2. Working with Organizations<a class="headerlink" href="#working-with-organizations" title="Permalink to this headline">¶</a></h3>
<p>You will recall that Organizations are umbrella entities that model your tenants in Stormpath, and allow you to better structure and control multi-tenant applications.</p>
<div class="section" id="how-to-create-an-organization">
<span id="create-org"></span><h4>How to Create an Organization<a class="headerlink" href="#how-to-create-an-organization" title="Permalink to this headline">¶</a></h4>
<p>You can create an Organization in Stormpath by sending the following request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">org</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">organizations</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bank of A&#39;</span><span class="p">,</span>
    <span class="s1">&#39;name_key&#39;</span><span class="p">:</span> <span class="s1">&#39;bank-of-a&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Which would return a new Organization object.</p>
</div>
<div class="section" id="adding-an-account-store-to-an-organization">
<h4>Adding an Account Store to an Organization<a class="headerlink" href="#adding-an-account-store-to-an-organization" title="Permalink to this headline">¶</a></h4>
<p>An Organization can be mapped to an Application so that users in the Organization can log-in to that application. Before you do this, you must first associate some users with the Organization so that there is someone to log in! To do this, you have to map some Account Stores to your Organization.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">asm</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">organization_account_store_mappings</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;account_store&#39;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
    <span class="s1">&#39;organization&#39;</span><span class="p">:</span> <span class="n">organization</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>These two attributes, <code class="docutils literal"><span class="pre">organization</span></code> and <code class="docutils literal"><span class="pre">account_store</span></code> are required, though you may add some optional attributes as well:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">listIndex</span></code>: Represents the priority in which this account_store will be consulted by the Organization during an authentication attempt. This is a zero-based index, meaning that an Account Store at <code class="docutils literal"><span class="pre">listIndex</span></code> of 0 will be consulted first, followed by the Account Store at listIndex 1, etc. Setting a negative value will default the value to 0, placing it first in the list. A listIndex of larger than the current list size will place the mapping at the end of the list and then default the value to (list size – 1).</li>
<li><code class="docutils literal"><span class="pre">is_default_account_store</span></code>: A <code class="docutils literal"><span class="pre">True</span></code> value indicates that new Accounts created by the Organization’s <code class="docutils literal"><span class="pre">/accounts</span></code> endpoint will be automatically saved to this mapping’s Directory or Group.</li>
</ul>
<p>In order to be able to add Groups and Accounts to the Organization in the way mentioned above, we should also make sure that we mark this Account Store as our default for both Accounts and Groups:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">asm</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">organization_account_store_mappings</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;organization&#39;</span><span class="p">:</span> <span class="n">organization</span><span class="p">,</span>
    <span class="s1">&#39;account_store&#39;</span><span class="p">:</span> <span class="n">directory</span><span class="p">,</span>
    <span class="s1">&#39;is_default_account_store&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s1">&#39;is_default_group_store&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Our Organization now has an associated Directory which can be used as an Account Store to add new Accounts and Groups. To enable login for the Accounts in this Organization, we must now map the Organization to an Application.</p>
</div>
<div class="section" id="registering-an-organization-as-an-account-store-for-an-application">
<h4>Registering an Organization as an Account Store for an Application<a class="headerlink" href="#registering-an-organization-as-an-account-store-for-an-application" title="Permalink to this headline">¶</a></h4>
<p>As described in <a class="reference internal" href="auth_n.html#authn"><span class="std std-ref">the Authentication chapter</span></a>, in order to allow users to log-in to an Application, you must map some kind of Account Store to it. One approach is to go one-by-one and map each Directory and/or Group to the Application. However, since we are building a multi-tenant app, and the Organization is itself an Account Store, we can just map our Organization resource to our Application resource. This would enable login for all of the Directories and Groups currently inside that Organization, as well as any we add in the future.</p>
<p>To map an Organization to an Application, follow the steps you would for any Account Store, as described in <a class="reference internal" href="auth_n.html#create-asm"><span class="std std-ref">Mapping a new Account Store</span></a>.</p>
</div>
<div class="section" id="adding-an-account-to-an-organization">
<span id="add-accnt-to-org"></span><h4>Adding an Account to an Organization<a class="headerlink" href="#adding-an-account-to-an-organization" title="Permalink to this headline">¶</a></h4>
<p>Adding a new Account to an Organization is exactly the same as adding them to a Directory, except that you use the Organization to handle the creation request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">organization</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;given_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Annie&#39;</span><span class="p">,</span>
    <span class="s1">&#39;surname&#39;</span><span class="p">:</span> <span class="s1">&#39;Nguyen&#39;</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;annie@nguyengland.me&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;annie@nguyengland.me&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;Changeme1&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="authenticating-an-account-against-an-organization">
<span id="multitenancy-auth-to-org"></span><h2>6.3. Authenticating an Account against an Organization<a class="headerlink" href="#authenticating-an-account-against-an-organization" title="Permalink to this headline">¶</a></h2>
<p>Authenticating an Account against an Organization works essentially the same way as described in <a class="reference internal" href="auth_n.html#how-login-works"><span class="std std-ref">4.1.2. How Login Attempts Work in Stormpath</span></a>. The only difference is that adding the Organization resource allows for an additional level of Account Stores.</p>
<p>When a login attempt is made against an Application’s <code class="docutils literal"><span class="pre">/loginAttempts</span></code> endpoint without specifying an Account Store, Stormpath will iterate through the index of Account Stores mapped to the Application, in priority order. For every Account Store entry:</p>
<ul class="simple">
<li>If it is a Directory or Group, attempt to log in on that resource.</li>
<li>If it is an Organization:<ul>
<li>Iterate through the index of Account Stores mapped to the Organization, in priority order. For every Account Store entry:<ul>
<li>If it is a Directory or Group, attempt to log in on that resource.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>If the login attempt does specify an Organization, then we simply jump to that point in the steps, and the Organization&#8217;s Account Stores are iterated through as described above.</p>
</div>
<div class="section" id="routing-users-to-their-tenant">
<span id="multitenancy-routing-users"></span><h2>6.4 Routing Users to their Tenant<a class="headerlink" href="#routing-users-to-their-tenant" title="Permalink to this headline">¶</a></h2>
<p>If you are designing a public multi-tenant web application that supports multiple application tenants with private data partitioning, then you will probably want some way for users to specify which tenant they are logging in to.</p>
<p>This tenant selection also extends to the requests that the user makes. For example, let&#8217;s say we have a multi-tenant e-commerce SaaS application that shows purchase history. If a user requests the <code class="docutils literal"><span class="pre">/purchases</span></code> view, they should only be able to see the purchases specific to their organization. This means that instead of executing a query like this to a database:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">purchases</span><span class="p">;</span>
</pre></div>
</div>
<p>The application needs to know the request user’s tenant identifier so they can show only the purchases for that tenant. The application might instead execute the following query:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">purchases</span> <span class="k">where</span> <span class="n">tenant_id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">?</span></code> is the <code class="docutils literal"><span class="pre">tenant_id</span></code> value obtained by inspecting the request.</p>
<p>So if an application needs this identifier with every request, how do you ensure it is transmitted to the application in the easiest possible way for your end users? The best method is to use the <a class="reference internal" href="reference.html#ref-organization"><span class="std std-ref">Organization resource</span></a> and it&#8217;s <code class="docutils literal"><span class="pre">nameKey</span></code> attribute.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Stormpath&#8217;s ID Site supports multi-tenancy right out of the box. For more information about how to handle user login in a multi-tenant set-up with ID Site, please see <a class="reference internal" href="idsite.html#idsite-multitenancy"><span class="std std-ref">the ID Site chapter</span></a>.</p>
</div>
<p>We present here two possible solutions that use this <code class="docutils literal"><span class="pre">nameKey</span></code>. You may support both if you wish to give your customers convenience options.</p>
<div class="section" id="sub-domain">
<h3>6.4.1. Sub-Domain<a class="headerlink" href="#sub-domain" title="Permalink to this headline">¶</a></h3>
<p>The first solution is to allow your users to access your application via a unique subdomain URL:</p>
<p><code class="docutils literal"><span class="pre">https://organizationNameKey.myapplication.io</span></code></p>
<p>The primary benefit here is that the application never needs to ask the user for the tenant identifier, because it is inherently part of every request in the <code class="docutils literal"><span class="pre">HOST</span></code> header. Also, since we are using the Organization resource&#8217;s <code class="docutils literal"><span class="pre">nameKey</span></code>, we can guarantee that the URL is unique.</p>
<p>There are also a few other things that we recommend with this approach:</p>
<div class="section" id="separate-domain-space">
<h4>Separate Domain Space<a class="headerlink" href="#separate-domain-space" title="Permalink to this headline">¶</a></h4>
<p>Keep your customer organization subdomains space completely separate from your company&#8217;s subdomain space by using a different top-level domain name for your SaaS application.</p>
<p>So if your company&#8217;s website URL is <code class="docutils literal"><span class="pre">http://mycompany.com</span></code>, then your customers could use the <code class="docutils literal"><span class="pre">http://mycompany.io</span></code> domain space:</p>
<p><code class="docutils literal"><span class="pre">http://customerA.mycompany.io</span></code></p>
<p>If you use the same domain space, it is possible that one of your customer&#8217;s will end up using a subdomain that you might want to use for your company.</p>
<p>If you didn&#8217;t want to use a separate top-level domain, you could also use sub-subdomains. For example, the app could be accessible here:</p>
<p><code class="docutils literal"><span class="pre">http://myapp.mycompany.com</span></code></p>
<p>And customer organization subdomains for that app would be accessible via:</p>
<p><code class="docutils literal"><span class="pre">http://customerA.myapp.mycompany.com</span></code></p>
<p>It is our opinion that the separate top-level domain (e.g. <code class="docutils literal"><span class="pre">http://mycompany.io</span></code>) is the nicer alternative: it is shorter, easier to remember, easier to type, and it also looks better.</p>
</div>
<div class="section" id="combine-with-login-form-field">
<h4>Combine With Login Form Field<a class="headerlink" href="#combine-with-login-form-field" title="Permalink to this headline">¶</a></h4>
<p>If a user from a customer organization ever accesses your app directly (<code class="docutils literal"><span class="pre">https://mycompany.io</span></code>) instead of using their subdomain (<code class="docutils literal"><span class="pre">https://customerA.mycompany.io</span></code>), you still might need to provide a tenant-aware login form (described below). After login, you can redirect them to their tenant-specific URL for all subsequent requests.</p>
</div>
</div>
<div class="section" id="login-form-field">
<h3>6.4.2. Login Form Field<a class="headerlink" href="#login-form-field" title="Permalink to this headline">¶</a></h3>
<p>An alternative, or complimentary, approach to tenant subdomains is to allow the user to specify their tenant on the login page, then storing that information. Then, for all subsequent requests to your application, you can:</p>
<ul class="simple">
<li>Inspect the session</li>
<li>Look up the tenant ID</li>
<li>Customize data views and queries based on the session&#8217;s Organization</li>
</ul>
<p>We advise that you auto-remember the login form tenant ID value so that field is pre-populated whenever a user returns to log in. Users don’t like having to remember and type that value in every time they log in.</p>
<p>As already mentioned, it is strongly recommended that your tenant identifier be an Organization <code class="docutils literal"><span class="pre">nameKey</span></code>. Firstly because Organizations are the recommended resource to use to model multi-tenancy, but also because the <code class="docutils literal"><span class="pre">nameKey</span></code> attribute is unique and follows the DNS specification, which means that you could at any time adopt the Sub-Domain approach mentioned above.</p>
<p>Stormpath supports quick implementation of all of these strategies with ID Site. For more information, please see <a class="reference internal" href="idsite.html#idsite-multitenancy"><span class="std std-ref">the ID Site chapter</span></a>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="idsite.html" class="btn btn-neutral float-right" title="7. Using ID Site" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="auth_z.html" class="btn btn-neutral" title="5. Authorization With Stormpath" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Stormpath, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/javascript_for_java.js"></script>
      <script type="text/javascript" src="_static/langpicker.js"></script>
      <script type="text/javascript" src="_static/scrollspy.js"></script>
      <script type="text/javascript" src="_static/gumshoe.min.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>